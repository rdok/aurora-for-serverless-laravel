
AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Aurora Serverless DB Cluster
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
Resources:
  AuroraSecrets:
    Type: "AWS::SecretsManager::Secret"
    Properties:
      Name: !Sub "${AWS::StackName}-0"
      GenerateSecretString:
        PasswordLength: 30
        ExcludeCharacters: '"@/\'
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: "password"
  AuthoriseAuroraAccess:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Authorise Aurora access by attaching this security group.'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - CidrIp: 127.0.0.1/32
          IpProtocol: "-1"
  AuthoriseAuroraAccessRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      GroupId: !GetAtt AuthoriseAuroraAccess.GroupId
      SourceSecurityGroupId: !GetAtt AuthoriseAuroraAccess.GroupId
  Aurora:
    Type: 'AWS::RDS::DBCluster'
    Properties:
      DatabaseName: main
      VpcSecurityGroupIds: [!GetAtt AuthoriseAuroraAccess.GroupId]
      MasterUsername: !Sub '{{resolve:secretsmanager:${AuroraSecrets}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${AuroraSecrets}:SecretString:password}}'
      Engine: aurora-mysql
      EngineVersion: 5.7.12
      EngineMode: serverless
      ScalingConfiguration:
        AutoPause: true
        MinCapacity: 1
        MaxCapacity: 1
        SecondsUntilAutoPause: 300
  LinkSecretsToAurora:
    Type: "AWS::SecretsManager::SecretTargetAttachment"
    Properties:
      SecretId: !Ref AuroraSecrets
      TargetId: !Ref Aurora
      TargetType: AWS::RDS::DBCluster
Outputs:
  AuroraSecretsARN:
    Value: !Ref LinkSecretsToAurora
    Export:
      Name: !Sub "${AWS::StackName}-AuroraSecretsARN"
  AuthoriseAuroraAccessSGGroupId:
    Value: !GetAtt AuthoriseAuroraAccess.GroupId
    Export:
      Name: !Sub "${AWS::StackName}-AuthoriseAuroraAccessSGGroupId"
